<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UvaPay - PIX</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:"Poppins",sans-serif}
body{background:linear-gradient(135deg,#2b0047,#3d0068);display:flex;align-items:center;justify-content:center;min-height:100vh;color:#fff;padding:20px}
.card{width:100%;max-width:520px;background:#1f1f1f;border-radius:16px;padding:28px;box-shadow:0 8px 30px rgba(0,0,0,0.4);text-align:center;}
h1{color:#b184ff;margin-bottom:6px}
.qr{margin:16px auto;background:#fff;padding:10px;border-radius:12px;width:260px;height:260px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.input{width:100%;padding:12px;border-radius:10px;border:none;background:#2e2e2e;color:#fff;margin-top:8px}
.btn{margin-top:12px;padding:12px;border-radius:10px;border:none;background:#7b33ff;color:#fff;font-weight:600;cursor:pointer;width:100%}
.small{color:#ccc;margin-top:8px}
.meta{text-align:left;color:#ddd;margin-top:12px}
.meta strong{color:#b184ff}
</style>
</head>
<body>
<div class="card">
  <h1>Pagamento PIX</h1>
  <p class="small">Escaneie o QR code ou copie o código PIX abaixo (pronto para colar no seu banco)</p>

  <div class="meta"><p><strong>Valor a pagar:</strong> <span id="valorText">R$ 0,00</span></p></div>
  <div class="meta"><p><strong>Você receberá:</strong> <span id="moedasText">0 Moedas VIPs</span></p></div>

  <div class="qr"><img id="qr" alt="QR Code" style="max-width:100%;height:auto"></div>

  <input id="paymentCode" class="input" readonly value="">
  <button id="copyCode" class="btn">Copiar código PIX (colar no app do banco)</button>
  <button id="paid" class="btn" style="background:#444;margin-top:8px">Já paguei</button>
  <button id="back" class="btn" style="background:#333;margin-top:8px">Voltar</button>
  <p class="small">A chave PIX não é exibida separadamente — o código que você copia já contém tudo que o banco precisa (inclui valor).</p>
</div>

<script>
// sua chave (mantida apenas no payload)
// NÃO mostramos a chave separadamente no UI
const DEFAULT_PIX_KEY = "brunoldiogenes@gmail.com";

function crc16(payload) {
  let crc = 0xFFFF;
  for (let i = 0; i < payload.length; i++) {
    crc ^= payload.charCodeAt(i) << 8;
    for (let j = 0; j < 8; j++) {
      crc = crc & 0x8000 ? (crc << 1) ^ 0x1021 : crc << 1;
      crc &= 0xFFFF;
    }
  }
  return crc.toString(16).toUpperCase().padStart(4,'0');
}
function f(id,value){ if(value===null||value===undefined||value==='') return ''; return id + String(value.length).padStart(2,'0') + value; }
function buildPayload(pixKey, amount, txid){
  let payload='';
  payload += f('00','01');
  payload += f('26', f('00','BR.GOV.BCB.PIX') + f('01', pixKey));
  payload += f('52','0000');
  payload += f('53','986');
  if(amount) payload += f('54', parseFloat(amount).toFixed(2));
  payload += f('58','BR');
  payload += f('59','UvaPay');
  payload += f('60','BRASIL');
  payload += f('62', f('05', f('01', txid)));
  const crc = crc16(payload + '6304');
  return payload + '6304' + crc;
}

const params = new URLSearchParams(window.location.search);
const valor = parseFloat(params.get('valor')||'0').toFixed(2);
const moedas = params.get('moedas')||'0';
// txid único
const txid = 'UVP' + Date.now();
// build payload
const payload = buildPayload(DEFAULT_PIX_KEY, valor, txid);

// populate UI
document.getElementById('valorText').textContent = valor ? `R$ ${Number(valor).toFixed(2)}` : 'R$ 0,00';
document.getElementById('moedasText').textContent = moedas ? `${Number(moedas).toLocaleString('pt-BR')} Moedas VIPs` : '-';
// show the payload (pasteable into bank PIX copy/paste field)
document.getElementById('paymentCode').value = payload;
// generate QR using Google Chart API with full payload
const qrUrl = 'https://chart.googleapis.com/chart?chs=400x400&cht=qr&chl=' + encodeURIComponent(payload);
document.getElementById('qr').src = qrUrl;

// copy actions
document.getElementById('copyCode').addEventListener('click', async ()=>{
  await navigator.clipboard.writeText(payload);
  alert('Código PIX copiado. Cole no campo "Copiar e Colar" do seu app bancário.');
});
document.getElementById('paid').addEventListener('click', ()=>{
  const q = new URLSearchParams();
  q.set('valor', valor);
  q.set('moedas', moedas);
  q.set('txid', txid);
  q.set('nome', params.get('nome')||'');
  q.set('cpf', params.get('cpf')||'');
  q.set('email', params.get('email')||'');
  q.set('telefone', params.get('telefone')||'');
  window.location.href = 'confirmacao.html?' + q.toString();
});
document.getElementById('back').addEventListener('click', ()=> history.back());
</script>
</body>
</html>
